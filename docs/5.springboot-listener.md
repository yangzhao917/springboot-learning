# Spring Boot ç›‘å¬å™¨è¯¦è§£

> æ‘˜è¦ï¼ˆTL;DRï¼‰
> - ç›®æ ‡ï¼šæŒæ¡ Spring Boot ç›‘å¬å™¨æœºåˆ¶åŠä½¿ç”¨æ–¹æ³•
> - å­¦ä¼šï¼šäº‹ä»¶å‘å¸ƒã€ç›‘å¬å™¨å®ç°ã€å¼‚æ­¥å¤„ç†ä¸æœ€ä½³å®è·µ
> - æ”¶è·ï¼šè§£è€¦ä¸šåŠ¡é€»è¾‘ã€æå‡ç³»ç»Ÿæ‰©å±•æ€§ä¸å¯ç»´æŠ¤æ€§

## ğŸ“š ç›®å½•

- [å†…å®¹æ¦‚è§ˆ](#å†…å®¹æ¦‚è§ˆ)
- [5.1 ä»€ä¹ˆæ˜¯ç›‘å¬å™¨](#51-ä»€ä¹ˆæ˜¯ç›‘å¬å™¨)
- [5.2 ç›‘å¬å™¨æ ¸å¿ƒç»„ä»¶](#52-ç›‘å¬å™¨æ ¸å¿ƒç»„ä»¶)
- [5.3 ç›‘å¬å™¨å®ç°æ–¹å¼](#53-ç›‘å¬å™¨å®ç°æ–¹å¼)
- [5.4 å†…ç½®äº‹ä»¶è¯¦è§£](#54-å†…ç½®äº‹ä»¶è¯¦è§£)
- [5.5 å®æˆ˜æ¡ˆä¾‹](#55-å®æˆ˜æ¡ˆä¾‹)
- [5.6 æµç¨‹åˆ†æ](#56-æµç¨‹åˆ†æ)
- [5.7 é«˜çº§ç‰¹æ€§](#57-é«˜çº§ç‰¹æ€§)
- [5.8 ä½¿ç”¨åœºæ™¯](#58-ä½¿ç”¨åœºæ™¯)
- [5.9 æœ€ä½³å®è·µ](#59-æœ€ä½³å®è·µ)
- [5.10 æ€»ç»“](#510-æ€»ç»“)

---

## å†…å®¹æ¦‚è§ˆ

æœ¬æ–‡æ¡£å…¨é¢ä»‹ç»Spring Bootç›‘å¬å™¨æœºåˆ¶ï¼Œæ¶µç›–ä»¥ä¸‹æ ¸å¿ƒå†…å®¹ï¼š

### ğŸ“š ä¸»è¦å†…å®¹

#### ç¬¬ä¸€éƒ¨åˆ†ï¼šç›‘å¬å™¨åŸºç¡€ï¼ˆå…¥é—¨ï¼‰
- **ç›‘å¬å™¨æ¦‚å¿µ**ï¼šä»€ä¹ˆæ˜¯ç›‘å¬å™¨ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç›‘å¬å™¨
- **æ ¸å¿ƒç»„ä»¶**ï¼šäº‹ä»¶ã€ç›‘å¬å™¨ã€äº‹ä»¶å‘å¸ƒå™¨çš„ä½œç”¨ä¸å…³ç³»
- **å·¥ä½œåŸç†**ï¼šç›‘å¬å™¨å¦‚ä½•è¢«è§¦å‘å’Œæ‰§è¡Œ

#### ç¬¬äºŒéƒ¨åˆ†ï¼šå®ç°æ–¹å¼ï¼ˆè¿›é˜¶ï¼‰
- **æ¥å£å®ç°**ï¼šé€šè¿‡å®ç°ApplicationListeneræ¥å£åˆ›å»ºç›‘å¬å™¨
- **æ³¨è§£é©±åŠ¨**ï¼šä½¿ç”¨@EventListeneræ³¨è§£ç®€åŒ–ç›‘å¬å™¨å¼€å‘
- **å¤šç§å®ç°æ–¹å¼**ï¼šSmartApplicationListenerã€æ‰‹åŠ¨æ³¨å†Œç­‰

#### ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨ï¼ˆå®æˆ˜ï¼‰
- **å†…ç½®äº‹ä»¶**ï¼šSpring Bootæä¾›çš„åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
- **è‡ªå®šä¹‰äº‹ä»¶**ï¼šåˆ›å»ºå’Œå‘å¸ƒè‡ªå®šä¹‰ä¸šåŠ¡äº‹ä»¶
- **å®é™…æ¡ˆä¾‹**ï¼šç”¨æˆ·æ³¨å†Œç›‘å¬ã€è®¢å•å¤„ç†ç›‘å¬ç­‰å®Œæ•´æ¡ˆä¾‹

#### ç¬¬å››éƒ¨åˆ†ï¼šæ·±å…¥ç†è§£ï¼ˆæ·±å…¥ï¼‰
- **æµç¨‹åˆ†æ**ï¼šé€šè¿‡æ—¶åºå›¾å’Œæµç¨‹å›¾æ·±å…¥ç†è§£äº‹ä»¶å‘å¸ƒã€ç›‘å¬å™¨åŒ¹é…å’Œæ‰§è¡Œæµç¨‹
- **é«˜çº§ç‰¹æ€§**ï¼šå¼‚æ­¥å¤„ç†ã€æ‰§è¡Œé¡ºåºã€æ¡ä»¶ç›‘å¬ã€äº‹åŠ¡äº‹ä»¶ç›‘å¬ç­‰
- **ä½¿ç”¨åœºæ™¯**ï¼šå¸¸è§åº”ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µ

### ğŸ”§ æ ¸å¿ƒæ³¨è§£

| æ³¨è§£ | ä½œç”¨ | è¯´æ˜ |
|------|------|------|
| `@EventListener` | å£°æ˜äº‹ä»¶ç›‘å¬æ–¹æ³• | æœ€å¸¸ç”¨çš„ç›‘å¬å™¨å®ç°æ–¹å¼ |
| `@Async` | å¼‚æ­¥æ‰§è¡Œç›‘å¬å™¨ | éœ€è¦é…åˆ@EnableAsyncä½¿ç”¨ |
| `@Order` | æŒ‡å®šç›‘å¬å™¨æ‰§è¡Œé¡ºåº | æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ |
| `@TransactionalEventListener` | äº‹åŠ¡äº‹ä»¶ç›‘å¬ | åœ¨äº‹åŠ¡ç‰¹å®šé˜¶æ®µè§¦å‘ï¼ˆAFTER_COMMITç­‰ï¼‰ |

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **è§£è€¦åˆ**ï¼šä¸šåŠ¡é€»è¾‘ä¸è¾…åŠ©åŠŸèƒ½åˆ†ç¦»
- **å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†é€»è¾‘
- **å¼‚æ­¥æ”¯æŒ**ï¼šé¿å…é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹
- **æ¡ä»¶æ§åˆ¶**ï¼šç²¾ç¡®æ§åˆ¶ç›‘å¬å™¨è§¦å‘æ¡ä»¶

---

## 5.1 ä»€ä¹ˆæ˜¯ç›‘å¬å™¨

### ğŸ¤” ä»€ä¹ˆæ˜¯ç›‘å¬å™¨ï¼Ÿ

**ç›‘å¬å™¨ï¼ˆListenerï¼‰**æ˜¯Spring Bootä¸­åŸºäºè§‚å¯Ÿè€…æ¨¡å¼å®ç°çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºç›‘å¬åº”ç”¨ç¨‹åºä¸­ç‰¹å®šäº‹ä»¶çš„å‘ç”Ÿï¼Œå¹¶åœ¨äº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚

### ğŸ’¡ ç”Ÿæ´»ä¸­çš„æ¯”å–»

æƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼š
- **ä¼ ç»Ÿæ–¹å¼**ï¼šä½ ç‚¹å®Œé¤åè¦ä¸€ç›´é—®æœåŠ¡å‘˜"å¥½äº†å—ï¼Ÿå¥½äº†å—ï¼Ÿ"
- **ç›‘å¬å™¨æ–¹å¼**ï¼šä½ ç‚¹å®Œé¤ååä¸‹ç­‰å¾…ï¼Œé¤åšå¥½åæœåŠ¡å‘˜ä¼šä¸»åŠ¨é€šçŸ¥ä½ 

ç›‘å¬å™¨å°±åƒé¤å…çš„æœåŠ¡å‘˜ï¼Œå½“ç‰¹å®šäº‹ä»¶ï¼ˆé¤åšå¥½äº†ï¼‰å‘ç”Ÿæ—¶ï¼Œä¼šä¸»åŠ¨é€šçŸ¥è®¢é˜…äº†è¯¥äº‹ä»¶çš„ç›‘å¬è€…ï¼ˆä½ ï¼‰ã€‚

### âœ¨ ç›‘å¬å™¨çš„ä¼˜åŠ¿

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹å¼ | ç›‘å¬å™¨æ–¹å¼ |
|------|---------|-----------|
| ä»£ç è€¦åˆåº¦ | ğŸŸ¥ é«˜ | ğŸŸ¢ ä½ |
| æ‰©å±•æ€§ | ğŸŸ¥ å·® | ğŸŸ¢ å¥½ |
| å¯ç»´æŠ¤æ€§ | ğŸŸ¥ å·® | ğŸŸ¢ å¥½ |
| æ€§èƒ½å½±å“ | ğŸŸ¥ å¯èƒ½é˜»å¡ | ğŸŸ¢ å¯å¼‚æ­¥å¤„ç† |

---

## 5.2 ç›‘å¬å™¨æ ¸å¿ƒç»„ä»¶

### ğŸ§© æ ¸å¿ƒç»„ä»¶ä»‹ç»

ç›‘å¬å™¨æœºåˆ¶ç”±ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š

#### 1. äº‹ä»¶ï¼ˆEventï¼‰
äº‹ä»¶æ˜¯ç›‘å¬å™¨ç›‘å¬çš„å¯¹è±¡ï¼Œé€šå¸¸ç»§æ‰¿è‡ª`ApplicationEvent`ç±»ã€‚

```java
public class CustomEvent extends ApplicationEvent {
    private String message;
    
    public CustomEvent(Object source, String message) {
        super(source);
        this.message = message;
    }
    
    public String getMessage() {
        return message;
    }
}
```

#### 2. ç›‘å¬å™¨ï¼ˆListenerï¼‰
ç›‘å¬å™¨è´Ÿè´£ç›‘å¬ç‰¹å®šäº‹ä»¶ï¼Œå¹¶åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œå¤„ç†é€»è¾‘ã€‚

#### 3. äº‹ä»¶å‘å¸ƒå™¨ï¼ˆEvent Publisherï¼‰
ç”¨äºå‘å¸ƒäº‹ä»¶ï¼Œè§¦å‘ç›‘å¬å™¨æ‰§è¡Œã€‚é€šå¸¸é€šè¿‡`ApplicationEventPublisher`æ¥å®ç°ã€‚

```java
@Service
public class EventPublisherService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void publishCustomEvent(String message) {
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(new CustomEvent(this, message));
    }
}
```

### ğŸ”„ å·¥ä½œåŸç†

ç›‘å¬å™¨çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. **äº‹ä»¶å‘å¸ƒ**ï¼šé€šè¿‡`ApplicationEventPublisher.publishEvent()`å‘å¸ƒäº‹ä»¶
2. **äº‹ä»¶è¯†åˆ«**ï¼šSpringå®¹å™¨æ ¹æ®äº‹ä»¶ç±»å‹æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨
3. **ç›‘å¬å™¨æ‰§è¡Œ**ï¼šæŒ‰ç…§`@Order`æ³¨è§£æŒ‡å®šçš„é¡ºåºä¾æ¬¡æ‰§è¡Œç›‘å¬å™¨
4. **å¼‚å¸¸å¤„ç†**ï¼šå¦‚æœç›‘å¬å™¨æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ä¼šç»§ç»­æ‰§è¡Œå…¶ä»–ç›‘å¬å™¨

```
å‘å¸ƒäº‹ä»¶ â†’ Springå®¹å™¨æ¥æ”¶ â†’ åŒ¹é…ç›‘å¬å™¨ â†’ æŒ‰é¡ºåºæ‰§è¡Œ â†’ è¿”å›ç»“æœ
```

---

## 5.3 ç›‘å¬å™¨å®ç°æ–¹å¼

### ğŸ¯ æ–¹å¼ä¸€ï¼šå®ç°ApplicationListeneræ¥å£

```java
@Component
public class CustomEventListener implements ApplicationListener<CustomEvent> {
    @Override
    public void onApplicationEvent(CustomEvent event) {
        // å¤„ç†äº‹ä»¶é€»è¾‘
        System.out.println("æ¥æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶: " + event.getMessage());
    }
}
```

### ğŸ¯ æ–¹å¼äºŒï¼šä½¿ç”¨@EventListeneræ³¨è§£

```java
@Component
public class CustomEventHandler {
    
    @EventListener
    public void handleCustomEvent(CustomEvent event) {
        // å¤„ç†äº‹ä»¶é€»è¾‘
        System.out.println("æ¥æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶: " + event.getMessage());
    }
}
```

### ğŸ¯ æ–¹å¼ä¸‰ï¼šä½¿ç”¨SmartApplicationListeneræ¥å£

`SmartApplicationListener`æ¥å£æä¾›äº†æ›´çµæ´»çš„äº‹ä»¶å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥ç›‘å¬å¤šä¸ªäº‹ä»¶ç±»å‹å¹¶æ”¯æŒæ¡ä»¶åˆ¤æ–­ï¼š

```java
@Component
public class SmartEventListener implements SmartApplicationListener {
    
    @Override
    public boolean supportsEventType(Class<? extends ApplicationEvent> eventType) {
        // æŒ‡å®šæ”¯æŒçš„äº‹ä»¶ç±»å‹
        return CustomEvent.class.isAssignableFrom(eventType);
    }
    
    @Override
    public boolean supportsSourceType(Class<?> sourceType) {
        // æŒ‡å®šæ”¯æŒçš„æºç±»å‹
        return true;
    }
    
    @Override
    public void onApplicationEvent(ApplicationEvent event) {
        CustomEvent customEvent = (CustomEvent) event;
        System.out.println("Smartç›‘å¬å™¨å¤„ç†äº‹ä»¶: " + customEvent.getMessage());
    }
    
    @Override
    public int getOrder() {
        // æŒ‡å®šæ‰§è¡Œé¡ºåº
        return 0;
    }
}
```

### ğŸ¯ æ–¹å¼å››ï¼šæ‰‹åŠ¨æ³¨å†Œç›‘å¬å™¨

é™¤äº†ä½¿ç”¨æ³¨è§£æ–¹å¼æ³¨å†Œï¼Œè¿˜å¯ä»¥åœ¨é…ç½®ç±»ä¸­æ‰‹åŠ¨æ³¨å†Œç›‘å¬å™¨ï¼š

```java
@Configuration
public class ListenerConfig {
    
    @Bean
    public ApplicationListener<CustomEvent> customEventListener() {
        return event -> {
            System.out.println("æ‰‹åŠ¨æ³¨å†Œçš„ç›‘å¬å™¨: " + event.getMessage());
        };
    }
}
```

æˆ–åœ¨å¯åŠ¨ç±»ä¸­é€šè¿‡`SpringApplication.addListeners()`æ–¹æ³•æ³¨å†Œï¼š

```java
@SpringBootApplication
public class App {
    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(App.class);
        app.addListeners(new CustomEventListener());
        app.run(args);
    }
}
```

### ğŸ“Œ ç›‘å¬å¤šä¸ªäº‹ä»¶

ä¸€ä¸ªç›‘å¬å™¨æ–¹æ³•å¯ä»¥ç›‘å¬å¤šä¸ªäº‹ä»¶ç±»å‹ï¼š

```java
@Component
public class MultiEventEventListener {
    
    @EventListener(classes = {CustomEvent.class, UserRegistrationEvent.class})
    public void handleMultipleEvents(ApplicationEvent event) {
        if (event instanceof CustomEvent) {
            CustomEvent customEvent = (CustomEvent) event;
            System.out.println("å¤„ç†CustomEvent: " + customEvent.getMessage());
        } else if (event instanceof UserRegistrationEvent) {
            UserRegistrationEvent userEvent = (UserRegistrationEvent) event;
            System.out.println("å¤„ç†UserRegistrationEvent: " + userEvent.getUser());
        }
    }
}
```

---

## 5.4 å†…ç½®äº‹ä»¶è¯¦è§£

Spring Bootæä¾›äº†å¤šä¸ªå†…ç½®äº‹ä»¶ï¼Œç”¨äºç›‘å¬åº”ç”¨ç”Ÿå‘½å‘¨æœŸï¼š

### ğŸ“… åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ç”¨é€” |
|---------|---------|------|
| `ApplicationStartingEvent` | åº”ç”¨å¯åŠ¨æ—¶ | æœ€æ—©è§¦å‘çš„äº‹ä»¶ |
| `ApplicationEnvironmentPreparedEvent` | Environmentå‡†å¤‡å®Œæˆ | å¯ä»¥è®¿é—®é…ç½®ä¿¡æ¯ |
| `ApplicationPreparedEvent` | åº”ç”¨å‡†å¤‡å®Œæˆ | åº”ç”¨ä¸Šä¸‹æ–‡åˆ›å»ºå®Œæˆ |
| `ApplicationStartedEvent` | åº”ç”¨å¯åŠ¨å®Œæˆ | ä½†è¿˜æœªæ¥æ”¶è¯·æ±‚ |
| `ApplicationReadyEvent` | åº”ç”¨å‡†å¤‡å°±ç»ª | å¯ä»¥æ¥æ”¶è¯·æ±‚ |
| `ApplicationFailedEvent` | åº”ç”¨å¯åŠ¨å¤±è´¥ | é”™è¯¯å¤„ç† |

### ğŸ“… Springæ¡†æ¶çº§åˆ«äº‹ä»¶

é™¤äº†Spring Bootæä¾›çš„äº‹ä»¶ï¼ŒSpringæ¡†æ¶æœ¬èº«ä¹Ÿæä¾›äº†å¤šä¸ªé‡è¦çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ç”¨é€” |
|---------|---------|------|
| `ContextRefreshedEvent` | åº”ç”¨ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæˆ | Beanåˆå§‹åŒ–å®Œæˆåè§¦å‘ |
| `ContextStartedEvent` | åº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨ | è°ƒç”¨`start()`æ–¹æ³•æ—¶è§¦å‘ |
| `ContextStoppedEvent` | åº”ç”¨ä¸Šä¸‹æ–‡åœæ­¢ | è°ƒç”¨`stop()`æ–¹æ³•æ—¶è§¦å‘ |
| `ContextClosedEvent` | åº”ç”¨ä¸Šä¸‹æ–‡å…³é—­ | åº”ç”¨å…³é—­æ—¶è§¦å‘ |
| `RequestHandledEvent` | HTTPè¯·æ±‚å¤„ç†å®Œæˆ | Webè¯·æ±‚å¤„ç†å®Œæˆåè§¦å‘ |

### ğŸ“Œ äº‹ä»¶ç›‘å¬ç¤ºä¾‹

#### Spring Bootäº‹ä»¶ç›‘å¬

```java
@Component
public class ApplicationStartupListener {
    
    private static final Logger logger = LoggerFactory.getLogger(ApplicationStartupListener.class);
    
    @EventListener
    public void handleApplicationReady(ApplicationReadyEvent event) {
        logger.info("åº”ç”¨å¯åŠ¨å®Œæˆï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚äº†...");
        // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ
    }
    
    @EventListener
    public void handleApplicationFailed(ApplicationFailedEvent event) {
        logger.error("åº”ç”¨å¯åŠ¨å¤±è´¥", event.getException());
        // å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œé”™è¯¯å¤„ç†
    }
}
```

#### Springæ¡†æ¶äº‹ä»¶ç›‘å¬

```java
@Component
public class ContextEventListener {
    
    private static final Logger logger = LoggerFactory.getLogger(ContextEventListener.class);
    
    @EventListener
    public void handleContextRefreshed(ContextRefreshedEvent event) {
        logger.info("åº”ç”¨ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæˆï¼Œæ‰€æœ‰Beanå·²åˆå§‹åŒ–");
        // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œä¾èµ–æ³¨å…¥å®Œæˆåçš„åˆå§‹åŒ–æ“ä½œ
    }
    
    @EventListener
    public void handleContextClosed(ContextClosedEvent event) {
        logger.info("åº”ç”¨ä¸Šä¸‹æ–‡æ­£åœ¨å…³é—­");
        // å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œèµ„æºæ¸…ç†å·¥ä½œ
    }
}
```

### ğŸ” äº‹ä»¶ç»§æ‰¿å…³ç³»

Springçš„äº‹ä»¶æœºåˆ¶æ”¯æŒç±»å‹ç»§æ‰¿ã€‚å¦‚æœä¸€ä¸ªç›‘å¬å™¨ç›‘å¬çˆ¶ç±»äº‹ä»¶ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å­ç±»äº‹ä»¶ï¼š

```java
// çˆ¶ç±»äº‹ä»¶
public class BaseEvent extends ApplicationEvent {
    // ...
}

// å­ç±»äº‹ä»¶
public class CustomEvent extends BaseEvent {
    // ...
}

// ç›‘å¬çˆ¶ç±»äº‹ä»¶çš„ç›‘å¬å™¨ï¼Œä¹Ÿèƒ½æ¥æ”¶å­ç±»äº‹ä»¶
@Component
public class BaseEventListener {
    @EventListener
    public void handleBaseEvent(BaseEvent event) {
        // è¿™ä¸ªç›‘å¬å™¨ä¼šåŒæ—¶æ¥æ”¶BaseEventå’ŒCustomEvent
        System.out.println("æ¥æ”¶åˆ°äº‹ä»¶: " + event.getClass().getName());
    }
}
```

---

## 5.5 å®æˆ˜æ¡ˆä¾‹

### ğŸ¯ ç”¨æˆ·æ³¨å†Œäº‹ä»¶ç›‘å¬

#### 1. å®šä¹‰ç”¨æˆ·æ³¨å†Œäº‹ä»¶

```java
// ç”¨æˆ·æ³¨å†Œäº‹ä»¶
public class UserRegistrationEvent extends ApplicationEvent {
    private User user;
    
    public UserRegistrationEvent(Object source, User user) {
        super(source);
        this.user = user;
    }
    
    public User getUser() {
        return user;
    }
}
```

#### 2. åˆ›å»ºç”¨æˆ·æ³¨å†Œç›‘å¬å™¨

```java
// ç”¨æˆ·æ³¨å†Œç›‘å¬å™¨
@Component
public class UserRegistrationListener {
    
    private static final Logger logger = LoggerFactory.getLogger(UserRegistrationListener.class);
    
    @EventListener
    public void handleUserRegistration(UserRegistrationEvent event) {
        User user = event.getUser();
        logger.info("æ–°ç”¨æˆ·æ³¨å†Œ: {}", user.getUsername());
        
        // å‘é€æ¬¢è¿é‚®ä»¶
        sendWelcomeEmail(user);
        
        // è®°å½•ç”¨æˆ·æ³¨å†Œæ—¥å¿—
        logUserRegistration(user);
    }
    
    private void sendWelcomeEmail(User user) {
        // å‘é€é‚®ä»¶é€»è¾‘
    }
    
    private void logUserRegistration(User user) {
        // è®°å½•æ—¥å¿—é€»è¾‘
    }
}
```

#### 3. åœ¨æœåŠ¡ä¸­å‘å¸ƒäº‹ä»¶

```java
@Service
public class UserService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void registerUser(User user) {
        // ç”¨æˆ·æ³¨å†Œé€»è¾‘
        // ...
        
        // å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
        eventPublisher.publishEvent(new UserRegistrationEvent(this, user));
    }
}
```

### ğŸ›’ è®¢å•å¤„ç†äº‹ä»¶ç›‘å¬ï¼ˆå®Œæ•´æ¡ˆä¾‹ï¼‰

è¿™æ˜¯ä¸€ä¸ªæ›´å®Œæ•´çš„å®é™…ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹ï¼š

#### 1. å®šä¹‰è®¢å•ç›¸å…³äº‹ä»¶

```java
// è®¢å•åˆ›å»ºäº‹ä»¶
public class OrderCreatedEvent extends ApplicationEvent {
    private Order order;
    
    public OrderCreatedEvent(Object source, Order order) {
        super(source);
        this.order = order;
    }
    
    public Order getOrder() {
        return order;
    }
}

// è®¢å•æ”¯ä»˜æˆåŠŸäº‹ä»¶
public class OrderPaidEvent extends ApplicationEvent {
    private Order order;
    private Payment payment;
    
    public OrderPaidEvent(Object source, Order order, Payment payment) {
        super(source);
        this.order = order;
        this.payment = payment;
    }
    
    public Order getOrder() {
        return order;
    }
    
    public Payment getPayment() {
        return payment;
    }
}
```

#### 2. åˆ›å»ºå¤šä¸ªç›‘å¬å™¨å¤„ç†ä¸åŒä¸šåŠ¡

```java
// åº“å­˜æ‰£å‡ç›‘å¬å™¨
@Component
@Order(1) // ä¼˜å…ˆæ‰§è¡Œ
public class InventoryDeductionListener {
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        Order order = event.getOrder();
        // æ‰£å‡åº“å­˜
        deductInventory(order);
    }
    
    private void deductInventory(Order order) {
        // åº“å­˜æ‰£å‡é€»è¾‘
    }
}

// å‘é€é€šçŸ¥ç›‘å¬å™¨
@Component
@Order(2)
public class NotificationListener {
    
    @EventListener
    @Async
    public void handleOrderPaid(OrderPaidEvent event) {
        Order order = event.getOrder();
        // å¼‚æ­¥å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
        sendPaymentNotification(order);
    }
    
    @EventListener
    @Async
    public void handleOrderCreated(OrderCreatedEvent event) {
        Order order = event.getOrder();
        // å¼‚æ­¥å‘é€è®¢å•åˆ›å»ºé€šçŸ¥
        sendOrderCreatedNotification(order);
    }
    
    private void sendPaymentNotification(Order order) {
        // å‘é€é€šçŸ¥é€»è¾‘
    }
    
    private void sendOrderCreatedNotification(Order order) {
        // å‘é€é€šçŸ¥é€»è¾‘
    }
}

// ç§¯åˆ†å¥–åŠ±ç›‘å¬å™¨
@Component
@Order(3)
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public class PointsRewardListener {
    
    @EventListener
    public void handleOrderPaid(OrderPaidEvent event) {
        Order order = event.getOrder();
        // äº‹åŠ¡æäº¤åç»™ç”¨æˆ·å¢åŠ ç§¯åˆ†
        addPointsToUser(order);
    }
    
    private void addPointsToUser(Order order) {
        // ç§¯åˆ†å¢åŠ é€»è¾‘
    }
}
```

#### 3. åœ¨æœåŠ¡ä¸­å‘å¸ƒäº‹ä»¶

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Autowired
    private OrderRepository orderRepository;
    
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        eventPublisher.publishEvent(new OrderCreatedEvent(this, order));
    }
    
    public void payOrder(Long orderId, Payment payment) {
        // 1. æ›´æ–°è®¢å•çŠ¶æ€
        Order order = orderRepository.findById(orderId).orElseThrow();
        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•æ”¯ä»˜æˆåŠŸäº‹ä»¶ï¼ˆåœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­ï¼‰
        eventPublisher.publishEvent(new OrderPaidEvent(this, order, payment));
        // æ³¨æ„ï¼šå¦‚æœåœ¨@Transactionalæ–¹æ³•ä¸­ï¼Œç›‘å¬å™¨å¯ä»¥ä½¿ç”¨@TransactionalEventListener
    }
}
```

---

## 5.6 æµç¨‹åˆ†æ

### ğŸ“Š äº‹ä»¶å‘å¸ƒä¸å¤„ç†æµç¨‹

åœ¨æŒæ¡äº†ç›‘å¬å™¨çš„åŸºæœ¬ä½¿ç”¨åï¼Œè®©æˆ‘ä»¬æ·±å…¥ç†è§£ç›‘å¬å™¨æœºåˆ¶çš„æ ¸å¿ƒæµç¨‹ã€‚æœ¬èŠ‚é€šè¿‡æ—¶åºå›¾å’Œæµç¨‹å›¾è¯¦ç»†è¯´æ˜äº‹ä»¶å‘å¸ƒã€ç›‘å¬å™¨åŒ¹é…å’Œæ‰§è¡Œç­‰å…³é”®æ­¥éª¤ã€‚

### ğŸ”„ äº‹ä»¶å‘å¸ƒæ—¶åºå›¾

ä»¥ä¸‹æ—¶åºå›¾å±•ç¤ºäº†ä»äº‹ä»¶å‘å¸ƒåˆ°ç›‘å¬å™¨æ‰§è¡Œçš„å®Œæ•´æµç¨‹ï¼š

```
å‘å¸ƒäº‹ä»¶ â†’ Springå®¹å™¨æ¥æ”¶ â†’ åŒ¹é…ç›‘å¬å™¨ â†’ æŒ‰é¡ºåºæ‰§è¡Œ â†’ è¿”å›ç»“æœ
```

### ğŸ—ºï¸ äº‹ä»¶å¤„ç†æµç¨‹å›¾

ä»¥ä¸‹æµç¨‹å›¾å±•ç¤ºäº†äº‹ä»¶å¤„ç†çš„è¯¦ç»†æ­¥éª¤å’Œåˆ†æ”¯é€»è¾‘ï¼š

```mermaid
flowchart TD
    Start([å¼€å§‹: ä¸šåŠ¡é€»è¾‘è§¦å‘]) --> Publish[å‘å¸ƒäº‹ä»¶<br/>publishEvent]
    Publish --> Container{Springå®¹å™¨<br/>æ¥æ”¶äº‹ä»¶}
    
    Container --> Match[æŸ¥æ‰¾åŒ¹é…çš„ç›‘å¬å™¨]
    Match --> Filter{è¿‡æ»¤ç›‘å¬å™¨}
    
    Filter -->|æ£€æŸ¥æ¡ä»¶| CheckCondition{æ¡ä»¶æ˜¯å¦æ»¡è¶³?}
    CheckCondition -->|å¦| Skip[è·³è¿‡è¯¥ç›‘å¬å™¨]
    CheckCondition -->|æ˜¯| AddToList[æ·»åŠ åˆ°æ‰§è¡Œåˆ—è¡¨]
    
    Filter --> Sort["æŒ‰@Orderæ’åº"]
    Sort --> Split{åˆ†ç¦»åŒæ­¥å’Œå¼‚æ­¥}
    
    Split --> SyncList[åŒæ­¥ç›‘å¬å™¨åˆ—è¡¨]
    Split --> AsyncList[å¼‚æ­¥ç›‘å¬å™¨åˆ—è¡¨]
    
    SyncList --> ExecuteSync[é¡ºåºæ‰§è¡ŒåŒæ­¥ç›‘å¬å™¨]
    ExecuteSync --> Loop{è¿˜æœ‰åŒæ­¥ç›‘å¬å™¨?}
    Loop -->|æ˜¯| ExecListener[æ‰§è¡Œç›‘å¬å™¨æ–¹æ³•]
    ExecListener --> HandleException{æ˜¯å¦å¼‚å¸¸?}
    HandleException -->|æ˜¯| LogError[è®°å½•å¼‚å¸¸<br/>ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª]
    HandleException -->|å¦| Loop
    LogError --> Loop
    Loop -->|å¦| AsyncList
    
    AsyncList --> SubmitAsync[æäº¤å¼‚æ­¥ç›‘å¬å™¨åˆ°çº¿ç¨‹æ± ]
    SubmitAsync --> AsyncExec[å¼‚æ­¥æ‰§è¡Œç›‘å¬å™¨]
    AsyncExec --> Return([è¿”å›æ§åˆ¶æƒç»™ä¸šåŠ¡æœåŠ¡])
    
    Skip --> Sort
    
    style Start fill:#e1f5ff
    style Return fill:#c8e6c9
    style LogError fill:#ffcdd2
    style ExecListener fill:#fff9c4
    style AsyncExec fill:#fff9c4
```

### ğŸ” ç›‘å¬å™¨æ³¨å†Œæµç¨‹

ä»¥ä¸‹æµç¨‹å›¾å±•ç¤ºäº†ç›‘å¬å™¨åœ¨Springå®¹å™¨ä¸­çš„æ³¨å†Œè¿‡ç¨‹ï¼š

```mermaid
flowchart LR
    Start([åº”ç”¨å¯åŠ¨]) --> Scan[æ‰«æç»„ä»¶]
    Scan --> FindListener{å‘ç°ç›‘å¬å™¨}
    
    FindListener -->|"@Component + @EventListener"| Annotated[æ³¨è§£ç›‘å¬å™¨]
    FindListener -->|å®ç°ApplicationListener| Interface[æ¥å£ç›‘å¬å™¨]
    FindListener -->|å®ç°SmartApplicationListener| Smart[æ™ºèƒ½ç›‘å¬å™¨]
    FindListener -->|"@Beanæ–¹æ³•è¿”å›"| BeanMethod[Beanæ–¹æ³•ç›‘å¬å™¨]
    
    Annotated --> Parse[è§£æç›‘å¬å™¨ä¿¡æ¯]
    Interface --> Parse
    Smart --> Parse
    BeanMethod --> Parse
    
    Parse --> Extract[æå–äº‹ä»¶ç±»å‹]
    Extract --> Register[æ³¨å†Œåˆ°ç›‘å¬å™¨æ³¨å†Œè¡¨]
    
    Register --> Store[å­˜å‚¨åˆ°<br/>ApplicationListenerRegistry]
    Store --> Ready([ç›‘å¬å™¨å°±ç»ª])
    
    style Start fill:#e1f5ff
    style Ready fill:#c8e6c9
    style Register fill:#fff9c4
```

### âš¡ åŒæ­¥vså¼‚æ­¥æ‰§è¡Œæµç¨‹å¯¹æ¯”

ä»¥ä¸‹æµç¨‹å›¾å¯¹æ¯”äº†åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼š

```mermaid
flowchart TD
    subgraph åŒæ­¥æ‰§è¡Œæ¨¡å¼
        Start1([ä¸šåŠ¡æœåŠ¡è°ƒç”¨]) --> Pub1[å‘å¸ƒäº‹ä»¶]
        Pub1 --> SyncExec[åŒæ­¥æ‰§è¡Œç›‘å¬å™¨]
        SyncExec --> Wait[ç­‰å¾…æ‰€æœ‰ç›‘å¬å™¨æ‰§è¡Œå®Œæˆ]
        Wait --> Return1([è¿”å›æ§åˆ¶æƒ])
        Return1 --> Continue1[ç»§ç»­ä¸šåŠ¡é€»è¾‘]
    end
    
    subgraph å¼‚æ­¥æ‰§è¡Œæ¨¡å¼
        Start2([ä¸šåŠ¡æœåŠ¡è°ƒç”¨]) --> Pub2[å‘å¸ƒäº‹ä»¶]
        Pub2 --> AsyncExec[æäº¤å¼‚æ­¥ç›‘å¬å™¨]
        AsyncExec --> Return2([ç«‹å³è¿”å›æ§åˆ¶æƒ])
        Return2 --> Continue2[ç»§ç»­ä¸šåŠ¡é€»è¾‘]
        AsyncExec --> ThreadPool[çº¿ç¨‹æ± æ‰§è¡Œ]
        ThreadPool --> AsyncProcess[å¼‚æ­¥å¤„ç†äº‹ä»¶]
    end
    
    style SyncExec fill:#fff9c4
    style AsyncExec fill:#fff9c4
    style ThreadPool fill:#c8e6c9
```

### ğŸ” äº‹åŠ¡äº‹ä»¶ç›‘å¬æµç¨‹

ä»¥ä¸‹æ—¶åºå›¾å±•ç¤ºäº†`@TransactionalEventListener`åœ¨äº‹åŠ¡ç¯å¢ƒä¸‹çš„æ‰§è¡Œæµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant Service as "ä¸šåŠ¡æœåŠ¡(@Transactional)"
    participant Transaction as äº‹åŠ¡ç®¡ç†å™¨
    participant Publisher as ApplicationEventPublisher
    participant EventQueue as äº‹åŠ¡äº‹ä»¶é˜Ÿåˆ—
    participant Listener as äº‹åŠ¡ç›‘å¬å™¨

    Service->>Transaction: 1. å¼€å§‹äº‹åŠ¡
    activate Transaction
    
    Service->>Service: 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    
    Service->>Publisher: 3. publishEvent(event)
    Publisher->>EventQueue: 4. å°†äº‹ä»¶åŠ å…¥é˜Ÿåˆ—<br/>(ä¸ç«‹å³æ‰§è¡Œ)
    EventQueue-->>Publisher: äº‹ä»¶å·²å…¥é˜Ÿ
    Publisher-->>Service: è¿”å›(éé˜»å¡)
    
    Service->>Service: 5. ç»§ç»­ä¸šåŠ¡é€»è¾‘
    
    Service->>Transaction: 6. æäº¤äº‹åŠ¡
    Transaction->>EventQueue: 7. äº‹åŠ¡æäº¤æˆåŠŸ<br/>è§¦å‘äº‹ä»¶å¤„ç†
    
    EventQueue->>Listener: 8. æ‰§è¡Œç›‘å¬å™¨<br/>(AFTER_COMMITé˜¶æ®µ)
    activate Listener
    Listener->>Listener: å¤„ç†äº‹ä»¶é€»è¾‘
    Listener-->>EventQueue: æ‰§è¡Œå®Œæˆ
    deactivate Listener
    
    Transaction-->>Service: 9. äº‹åŠ¡æäº¤å®Œæˆ
    
    Note over Transaction: å¦‚æœäº‹åŠ¡å›æ»š
    Transaction->>EventQueue: 7b. äº‹åŠ¡å›æ»š<br/>è§¦å‘AFTER_ROLLBACKç›‘å¬å™¨
```

### ğŸ“‹ å…³é”®æµç¨‹è¯´æ˜

#### 1. äº‹ä»¶å‘å¸ƒæµç¨‹
- **æ­¥éª¤1**ï¼šä¸šåŠ¡æœåŠ¡è°ƒç”¨`ApplicationEventPublisher.publishEvent()`
- **æ­¥éª¤2**ï¼šSpringå®¹å™¨æ¥æ”¶äº‹ä»¶å¯¹è±¡
- **æ­¥éª¤3**ï¼šå®¹å™¨æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨ï¼ˆæ ¹æ®äº‹ä»¶ç±»å‹ï¼‰
- **æ­¥éª¤4**ï¼šæŒ‰`@Order`æ³¨è§£æ’åºç›‘å¬å™¨
- **æ­¥éª¤5**ï¼šåˆ†ç¦»åŒæ­¥å’Œå¼‚æ­¥ç›‘å¬å™¨

#### 2. ç›‘å¬å™¨åŒ¹é…æµç¨‹
- **ç±»å‹åŒ¹é…**ï¼šæ£€æŸ¥ç›‘å¬å™¨ç›‘å¬çš„äº‹ä»¶ç±»å‹æ˜¯å¦ä¸å‘å¸ƒçš„äº‹ä»¶åŒ¹é…
- **æ¡ä»¶åŒ¹é…**ï¼šå¦‚æœä½¿ç”¨`condition`å±æ€§ï¼Œè¯„ä¼°SpELè¡¨è¾¾å¼
- **æºç±»å‹åŒ¹é…**ï¼šå¯¹äº`SmartApplicationListener`ï¼Œæ£€æŸ¥sourceç±»å‹

#### 3. åŒæ­¥æ‰§è¡Œæµç¨‹
- **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰ç…§`@Order`å€¼ä»å°åˆ°å¤§ä¾æ¬¡æ‰§è¡Œ
- **å¼‚å¸¸éš”ç¦»**ï¼šç›‘å¬å™¨å¼‚å¸¸ä¸å½±å“å…¶ä»–ç›‘å¬å™¨
- **é˜»å¡ç­‰å¾…**ï¼šä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰åŒæ­¥ç›‘å¬å™¨æ‰§è¡Œå®Œæˆ

#### 4. å¼‚æ­¥æ‰§è¡Œæµç¨‹
- **çº¿ç¨‹æ± æäº¤**ï¼šå°†å¼‚æ­¥ç›‘å¬å™¨æäº¤åˆ°çº¿ç¨‹æ± 
- **ç«‹å³è¿”å›**ï¼šä¸ç­‰å¾…å¼‚æ­¥ç›‘å¬å™¨æ‰§è¡Œå®Œæˆ
- **å¹¶å‘æ‰§è¡Œ**ï¼šå¤šä¸ªå¼‚æ­¥ç›‘å¬å™¨å¯ä»¥å¹¶å‘æ‰§è¡Œ

#### 5. äº‹åŠ¡äº‹ä»¶ç›‘å¬æµç¨‹
- **äº‹ä»¶å…¥é˜Ÿ**ï¼šäº‹åŠ¡ä¸­çš„äº‹ä»¶å…ˆåŠ å…¥é˜Ÿåˆ—ï¼Œä¸ç«‹å³æ‰§è¡Œ
- **å»¶è¿Ÿè§¦å‘**ï¼šåœ¨äº‹åŠ¡æäº¤/å›æ»šçš„ç‰¹å®šé˜¶æ®µè§¦å‘
- **äº‹åŠ¡éš”ç¦»**ï¼šç¡®ä¿äº‹ä»¶å¤„ç†åœ¨æ­£ç¡®çš„äº‹åŠ¡é˜¶æ®µæ‰§è¡Œ

### ğŸ’¡ æµç¨‹å…³é”®ç‚¹æ€»ç»“

| æµç¨‹é˜¶æ®µ | å…³é”®ç‚¹ | è¯´æ˜ |
|---------|--------|------|
| **äº‹ä»¶å‘å¸ƒ** | éé˜»å¡ | åŒæ­¥ç›‘å¬å™¨ä¼šé˜»å¡ï¼Œå¼‚æ­¥ç›‘å¬å™¨ä¸ä¼š |
| **ç›‘å¬å™¨åŒ¹é…** | ç±»å‹ç»§æ‰¿ | ç›‘å¬çˆ¶ç±»äº‹ä»¶çš„ç›‘å¬å™¨ä¹Ÿèƒ½æ¥æ”¶å­ç±»äº‹ä»¶ |
| **æ‰§è¡Œé¡ºåº** | @Orderæ§åˆ¶ | æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ |
| **å¼‚å¸¸å¤„ç†** | éš”ç¦»æœºåˆ¶ | ç›‘å¬å™¨å¼‚å¸¸ä¸å½±å“ä¸»æµç¨‹å’Œå…¶ä»–ç›‘å¬å™¨ |
| **äº‹åŠ¡ç›‘å¬** | å»¶è¿Ÿæ‰§è¡Œ | åœ¨äº‹åŠ¡ç‰¹å®šé˜¶æ®µæ‰æ‰§è¡Œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ |

---

## 5.7 é«˜çº§ç‰¹æ€§

### âš¡ å¼‚æ­¥å¤„ç†

é»˜è®¤æƒ…å†µä¸‹ï¼Œç›‘å¬å™¨æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œçš„ã€‚å¦‚æœç›‘å¬å™¨å¤„ç†é€»è¾‘è¾ƒé‡ï¼Œå¯èƒ½ä¼šå½±å“ä¸»ä¸šåŠ¡æµç¨‹çš„æ€§èƒ½ã€‚

```java
@Component
public class AsyncEventListener {
    
    @EventListener
    @Async
    public void handleCustomEvent(CustomEvent event) {
        // å¼‚æ­¥å¤„ç†äº‹ä»¶
        System.out.println("å¼‚æ­¥å¤„ç†äº‹ä»¶: " + event.getMessage());
    }
}
```

éœ€è¦åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ `@EnableAsync`æ³¨è§£å¯ç”¨å¼‚æ­¥æ”¯æŒã€‚

### ğŸ”¢ æ‰§è¡Œé¡ºåº

å¦‚æœæœ‰å¤šä¸ªç›‘å¬å™¨ç›‘å¬åŒä¸€äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡`@Order`æ³¨è§£æŒ‡å®šæ‰§è¡Œé¡ºåºï¼š

```java
@Component
@Order(1)
public class FirstEventListener {
    
    @EventListener
    public void handleCustomEvent(CustomEvent event) {
        System.out.println("ç¬¬ä¸€ä¸ªç›‘å¬å™¨å¤„ç†äº‹ä»¶");
    }
}

@Component
@Order(2)
public class SecondEventListener {
    
    @EventListener
    public void handleCustomEvent(CustomEvent event) {
        System.out.println("ç¬¬äºŒä¸ªç›‘å¬å™¨å¤„ç†äº‹ä»¶");
    }
}
```

### ğŸ¯ æ¡ä»¶ç›‘å¬

å¯ä»¥ä½¿ç”¨`@EventListener`çš„conditionå±æ€§å®ç°æ¡ä»¶ç›‘å¬ï¼š

```java
@Component
public class ConditionalEventListener {
    
    @EventListener(condition = "#event.message.length() > 5")
    public void handleLongMessageEvent(CustomEvent event) {
        System.out.println("åªå¤„ç†æ¶ˆæ¯é•¿åº¦å¤§äº5çš„äº‹ä»¶: " + event.getMessage());
    }
}
```

### ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†

ç›‘å¬å™¨ä¸­çš„å¼‚å¸¸ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡æµç¨‹ï¼Œä½†éœ€è¦é€‚å½“å¤„ç†ä»¥é¿å…æ•°æ®ä¸ä¸€è‡´ï¼š

```java
@Component
public class SafeEventListener {
    
    private static final Logger logger = LoggerFactory.getLogger(SafeEventListener.class);
    
    @EventListener
    public void handleCustomEvent(CustomEvent event) {
        try {
            // å¤„ç†äº‹ä»¶é€»è¾‘
            processEvent(event);
        } catch (Exception e) {
            logger.error("å¤„ç†äº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸", e);
            // å¯ä»¥é€‰æ‹©é‡æ–°å…¥é˜Ÿã€è®°å½•é”™è¯¯æ—¥å¿—ç­‰å¤„ç†æ–¹å¼
        }
    }
    
    private void processEvent(CustomEvent event) {
        // å…·ä½“å¤„ç†é€»è¾‘
    }
}
```

### ğŸ’¾ äº‹åŠ¡äº‹ä»¶ç›‘å¬

`@TransactionalEventListener`æ³¨è§£å…è®¸åœ¨äº‹åŠ¡çš„ç‰¹å®šé˜¶æ®µè§¦å‘ç›‘å¬å™¨ï¼Œè¿™å¯¹äºéœ€è¦åœ¨äº‹åŠ¡æäº¤åæ‰§è¡Œçš„æ“ä½œéå¸¸æœ‰ç”¨ï¼š

```java
@Component
public class TransactionalEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleAfterCommit(CustomEvent event) {
        // äº‹åŠ¡æäº¤åæ‰§è¡Œ
        System.out.println("äº‹åŠ¡å·²æäº¤ï¼Œå¤„ç†äº‹ä»¶: " + event.getMessage());
    }
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)
    public void handleAfterRollback(CustomEvent event) {
        // äº‹åŠ¡å›æ»šåæ‰§è¡Œ
        System.out.println("äº‹åŠ¡å·²å›æ»šï¼Œå¤„ç†äº‹ä»¶: " + event.getMessage());
    }
    
    @TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
    public void handleBeforeCommit(CustomEvent event) {
        // äº‹åŠ¡æäº¤å‰æ‰§è¡Œ
        System.out.println("äº‹åŠ¡æäº¤å‰ï¼Œå¤„ç†äº‹ä»¶: " + event.getMessage());
    }
}
```

**äº‹åŠ¡é˜¶æ®µè¯´æ˜ï¼š**

| é˜¶æ®µ | è¯´æ˜ |
|------|------|
| `AFTER_COMMIT` | äº‹åŠ¡æäº¤æˆåŠŸåæ‰§è¡Œï¼ˆé»˜è®¤ï¼‰ |
| `AFTER_ROLLBACK` | äº‹åŠ¡å›æ»šåæ‰§è¡Œ |
| `BEFORE_COMMIT` | äº‹åŠ¡æäº¤å‰æ‰§è¡Œ |
| `AFTER_COMPLETION` | äº‹åŠ¡å®Œæˆåæ‰§è¡Œï¼ˆæ— è®ºæäº¤è¿˜æ˜¯å›æ»šï¼‰ |

**æ³¨æ„äº‹é¡¹ï¼š**
- ä½¿ç”¨`@TransactionalEventListener`æ—¶ï¼Œäº‹ä»¶å¿…é¡»æ˜¯åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å‘å¸ƒçš„
- å¦‚æœä¸åœ¨äº‹åŠ¡ä¸­å‘å¸ƒäº‹ä»¶ï¼Œéœ€è¦ä½¿ç”¨`fallbackExecution = true`æ¥ç¡®ä¿ç›‘å¬å™¨èƒ½å¤Ÿæ‰§è¡Œ

```java
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT, fallbackExecution = true)
public void handleEvent(CustomEvent event) {
    // å³ä½¿åœ¨éäº‹åŠ¡ç¯å¢ƒä¸‹ä¹Ÿä¼šæ‰§è¡Œ
}
```

### ğŸ§µ çº¿ç¨‹æ¨¡å‹è¯¦è§£

#### åŒæ­¥æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œç›‘å¬å™¨åœ¨å‘å¸ƒäº‹ä»¶çš„åŒä¸€çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œï¼š

```java
// ä¸»çº¿ç¨‹
@Service
public class UserService {
    @Autowired
    private ApplicationEventPublisher publisher;
    
    public void registerUser(User user) {
        // 1. ä¸»çº¿ç¨‹æ‰§è¡Œ
        publisher.publishEvent(new UserRegistrationEvent(this, user));
        // 2. ç›‘å¬å™¨åœ¨åŒä¸€çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œ
        // 3. æ‰€æœ‰ç›‘å¬å™¨æ‰§è¡Œå®Œæˆåï¼Œç»§ç»­æ‰§è¡Œåç»­ä»£ç 
    }
}
```

#### å¼‚æ­¥æ‰§è¡Œ

ä½¿ç”¨`@Async`æ³¨è§£å¯ä»¥å®ç°å¼‚æ­¥æ‰§è¡Œï¼Œç›‘å¬å™¨ä¼šåœ¨ç‹¬ç«‹çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼š

```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-event-");
        executor.initialize();
        return executor;
    }
}

@Component
public class AsyncEventListener {
    @EventListener
    @Async
    public void handleEvent(CustomEvent event) {
        // åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œ
        System.out.println("å¼‚æ­¥çº¿ç¨‹: " + Thread.currentThread().getName());
    }
}
```

---

## 5.8 ä½¿ç”¨åœºæ™¯

### ğŸ¯ å¸¸è§ä½¿ç”¨åœºæ™¯

#### 1. åº”ç”¨ç”Ÿå‘½å‘¨æœŸç›‘æ§
- åº”ç”¨å¯åŠ¨å®Œæˆåçš„åˆå§‹åŒ–æ“ä½œ
- åº”ç”¨å…³é—­å‰çš„èµ„æºæ¸…ç†å·¥ä½œ

#### 2. ä¸šåŠ¡äº‹ä»¶å¤„ç†
- ç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶
- è®¢å•åˆ›å»ºåæ›´æ–°åº“å­˜
- æ”¯ä»˜æˆåŠŸåå‘é€é€šçŸ¥

#### 3. æ—¥å¿—è®°å½•ä¸å®¡è®¡
- è®°å½•é‡è¦ä¸šåŠ¡æ“ä½œæ—¥å¿—
- ç”¨æˆ·è¡Œä¸ºå®¡è®¡è·Ÿè¸ª

#### 4. æ•°æ®åŒæ­¥
- ä¸»æ•°æ®å˜æ›´ååŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿ
- ç¼“å­˜æ›´æ–°é€šçŸ¥

#### 5. å¼‚æ­¥ä»»åŠ¡å¤„ç†
- è€—æ—¶æ“ä½œçš„å¼‚æ­¥å¤„ç†
- æ¶ˆæ¯é€šçŸ¥å‘é€

#### 6. ç¼“å­˜ç®¡ç†
- æ•°æ®å˜æ›´åæ¸…é™¤ç›¸å…³ç¼“å­˜
- ç¼“å­˜é¢„çƒ­å¤„ç†

#### 7. æŒ‡æ ‡æ”¶é›†
- ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡
- æ€§èƒ½ç›‘æ§æ•°æ®æ”¶é›†

---

## 5.9 æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **åˆç†ä½¿ç”¨å¼‚æ­¥å¤„ç†**ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œä½¿ç”¨`@Async`æ³¨è§£é¿å…é˜»å¡ä¸»æµç¨‹
2. **æ³¨æ„å¼‚å¸¸å¤„ç†**ï¼šç›‘å¬å™¨ä¸­çš„å¼‚å¸¸ä¸åº”å½±å“ä¸»ä¸šåŠ¡æµç¨‹
3. **é¿å…å¾ªç¯ä¾èµ–**ï¼šç›‘å¬å™¨ä¸­å‘å¸ƒæ–°äº‹ä»¶æ—¶è¦æ³¨æ„é¿å…å½¢æˆå¾ªç¯
4. **æ§åˆ¶ç›‘å¬å™¨æ•°é‡**ï¼šè¿‡å¤šçš„ç›‘å¬å™¨å¯èƒ½å½±å“åº”ç”¨æ€§èƒ½
5. **ä½¿ç”¨æ¡ä»¶ç›‘å¬**ï¼šé€šè¿‡conditionå±æ€§ç²¾ç¡®æ§åˆ¶ç›‘å¬å™¨çš„è§¦å‘æ¡ä»¶

### âŒ é¿å…çš„åšæ³•

1. **é¿å…åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œå¤æ‚ä¸šåŠ¡é€»è¾‘**ï¼šåº”è¯¥åªåšäº‹ä»¶å¤„ç†ï¼Œå¤æ‚é€»è¾‘åº”è°ƒç”¨æœåŠ¡å±‚
2. **é¿å…åœ¨ç›‘å¬å™¨ä¸­æŠ›å‡ºæœªå¤„ç†å¼‚å¸¸**ï¼šä¼šå½±å“å…¶ä»–ç›‘å¬å™¨æ‰§è¡Œ
3. **é¿å…åœ¨ç›‘å¬å™¨ä¸­è¿›è¡Œé˜»å¡æ“ä½œ**ï¼šåº”ä½¿ç”¨å¼‚æ­¥å¤„ç†
4. **é¿å…åœ¨ç›‘å¬å™¨ä¸­ä¿®æ”¹äº‹ä»¶å¯¹è±¡**ï¼šäº‹ä»¶åº”è¯¥æ˜¯ä¸å¯å˜çš„ï¼Œä¿®æ”¹å¯èƒ½å½±å“å…¶ä»–ç›‘å¬å™¨
5. **é¿å…ç›‘å¬å™¨ä¹‹é—´çš„ç›¸äº’ä¾èµ–**ï¼šä¿æŒç›‘å¬å™¨ç‹¬ç«‹ï¼Œé¿å…å½¢æˆè°ƒç”¨é“¾

### ğŸ§ª ç›‘å¬å™¨æµ‹è¯•

æµ‹è¯•ç›‘å¬å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Springçš„æµ‹è¯•æ¡†æ¶ï¼š

```java
@SpringBootTest
class UserRegistrationListenerTest {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Autowired
    private UserRegistrationListener listener;
    
    @MockBean
    private EmailService emailService; // æ¨¡æ‹Ÿé‚®ä»¶æœåŠ¡
    
    @Test
    void testUserRegistrationEvent() {
        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        User user = new User();
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        
        // å‘å¸ƒäº‹ä»¶
        UserRegistrationEvent event = new UserRegistrationEvent(this, user);
        eventPublisher.publishEvent(event);
        
        // éªŒè¯é‚®ä»¶æœåŠ¡è¢«è°ƒç”¨
        verify(emailService, times(1)).sendWelcomeEmail(user);
    }
}
```

æˆ–è€…ä½¿ç”¨`@TestConfiguration`åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯•é…ç½®ï¼š

```java
@SpringBootTest
class CustomEventListenerTest {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    private List<String> receivedEvents = new ArrayList<>();
    
    @TestConfiguration
    static class TestConfig {
        @Bean
        public ApplicationListener<CustomEvent> testListener() {
            return event -> {
                // åœ¨æµ‹è¯•ä¸­æ”¶é›†äº‹ä»¶
                receivedEvents.add(event.getMessage());
            };
        }
    }
    
    @Test
    void testEventPublishing() {
        eventPublisher.publishEvent(new CustomEvent(this, "test message"));
        
        assertThat(receivedEvents).containsExactly("test message");
    }
}
```

### âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆç†ä½¿ç”¨å¼‚æ­¥å¤„ç†**ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼ŒåŠ¡å¿…ä½¿ç”¨`@Async`é¿å…é˜»å¡
2. **æ§åˆ¶ç›‘å¬å™¨æ•°é‡**ï¼šè¿‡å¤šçš„ç›‘å¬å™¨ä¼šå½±å“äº‹ä»¶å‘å¸ƒæ€§èƒ½
3. **ä¼˜åŒ–äº‹ä»¶å¯¹è±¡**ï¼šäº‹ä»¶å¯¹è±¡åº”å°½é‡è½»é‡ï¼Œé¿å…åŒ…å«å¤§é‡æ•°æ®
4. **ä½¿ç”¨æ¡ä»¶ç›‘å¬**ï¼šé€šè¿‡`condition`å±æ€§å‡å°‘ä¸å¿…è¦çš„ç›‘å¬å™¨æ‰§è¡Œ
5. **æ‰¹é‡äº‹ä»¶å¤„ç†**ï¼šå¯¹äºé«˜é¢‘äº‹ä»¶ï¼Œè€ƒè™‘æ‰¹é‡å¤„ç†æœºåˆ¶

```java
@Component
public class OptimizedEventListener {
    
    // ä½¿ç”¨æ¡ä»¶ç›‘å¬ï¼Œåªå¤„ç†æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
    @EventListener(condition = "#event.priority == 'HIGH'")
    @Async
    public void handleHighPriorityEvent(CustomEvent event) {
        // åªå¤„ç†é«˜ä¼˜å…ˆçº§äº‹ä»¶ï¼Œå¼‚æ­¥æ‰§è¡Œ
    }
}
```

---

## 5.10 æ€»ç»“

### ğŸ“ æœ¬ç« è¦ç‚¹å›é¡¾

1. **ç›‘å¬å™¨æ¦‚å¿µ**ï¼šåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶å¤„ç†æœºåˆ¶
2. **æ ¸å¿ƒç»„ä»¶**ï¼šäº‹ä»¶ã€ç›‘å¬å™¨ã€äº‹ä»¶å‘å¸ƒå™¨åŠå…¶å·¥ä½œåŸç†
3. **å®ç°æ–¹å¼**ï¼šæ¥å£å®ç°ã€æ³¨è§£é©±åŠ¨ã€SmartApplicationListenerã€æ‰‹åŠ¨æ³¨å†Œ
4. **å†…ç½®äº‹ä»¶**ï¼šSpring Bootåº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’ŒSpringæ¡†æ¶çº§åˆ«äº‹ä»¶
5. **å®æˆ˜æ¡ˆä¾‹**ï¼šç”¨æˆ·æ³¨å†Œç›‘å¬ã€è®¢å•å¤„ç†ç›‘å¬ç­‰å®é™…ä¸šåŠ¡åœºæ™¯
6. **æµç¨‹åˆ†æ**ï¼šäº‹ä»¶å‘å¸ƒã€ç›‘å¬å™¨åŒ¹é…ã€åŒæ­¥/å¼‚æ­¥æ‰§è¡Œã€äº‹åŠ¡äº‹ä»¶ç›‘å¬çš„å®Œæ•´æµç¨‹
7. **é«˜çº§ç‰¹æ€§**ï¼š
   - å¼‚æ­¥å¤„ç†ï¼ˆ@Asyncï¼‰
   - æ‰§è¡Œé¡ºåºæ§åˆ¶ï¼ˆ@Orderï¼‰
   - æ¡ä»¶ç›‘å¬ï¼ˆconditionå±æ€§ï¼‰
   - äº‹åŠ¡äº‹ä»¶ç›‘å¬ï¼ˆ@TransactionalEventListenerï¼‰
   - å¼‚å¸¸å¤„ç†ç­–ç•¥
   - çº¿ç¨‹æ¨¡å‹ï¼ˆåŒæ­¥vså¼‚æ­¥ï¼‰
8. **ä½¿ç”¨åœºæ™¯**ï¼šç”Ÿå‘½å‘¨æœŸç›‘æ§ã€ä¸šåŠ¡äº‹ä»¶å¤„ç†ã€æ—¥å¿—å®¡è®¡ã€æ•°æ®åŒæ­¥ã€å¼‚æ­¥ä»»åŠ¡ç­‰
9. **æœ€ä½³å®è·µ**ï¼š
   - åˆç†ä½¿ç”¨å¼‚æ­¥å¤„ç†
   - æ³¨æ„å¼‚å¸¸å¤„ç†
   - é¿å…å¾ªç¯ä¾èµ–
   - ä¿æŒäº‹ä»¶å¯¹è±¡ä¸å¯å˜
   - æ§åˆ¶ç›‘å¬å™¨æ•°é‡
10. **æµ‹è¯•æ–¹æ³•**ï¼šä½¿ç”¨Springæµ‹è¯•æ¡†æ¶æµ‹è¯•ç›‘å¬å™¨åŠŸèƒ½
11. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼‚æ­¥å¤„ç†ã€æ¡ä»¶ç›‘å¬ã€äº‹ä»¶å¯¹è±¡è½»é‡åŒ–

### ğŸ¯ å­¦ä¹ å»ºè®®

1. **åŠ¨æ‰‹å®è·µ**ï¼šåˆ›å»ºç®€å•çš„ç›‘å¬å™¨å¹¶æµ‹è¯•å…¶å·¥ä½œåŸç†
2. **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£è§‚å¯Ÿè€…æ¨¡å¼åœ¨Springä¸­çš„å®ç°ï¼ŒæŒæ¡äº‹ä»¶å‘å¸ƒå’Œæ‰§è¡Œæµç¨‹
3. **å…³æ³¨æ€§èƒ½**ï¼šåˆç†ä½¿ç”¨å¼‚æ­¥å¤„ç†é¿å…é˜»å¡ä¸»æµç¨‹ï¼Œæ§åˆ¶ç›‘å¬å™¨æ•°é‡
4. **æ³¨æ„å¼‚å¸¸**ï¼šç¡®ä¿ç›‘å¬å™¨ä¸­çš„å¼‚å¸¸ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡æµç¨‹
5. **æŒæ¡é«˜çº§ç‰¹æ€§**ï¼šç†Ÿç»ƒä½¿ç”¨äº‹åŠ¡äº‹ä»¶ç›‘å¬ã€æ¡ä»¶ç›‘å¬ç­‰é«˜çº§åŠŸèƒ½
6. **ç¼–å†™æµ‹è¯•**ï¼šä¸ºç›‘å¬å™¨ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§

### ğŸ” å…³é”®çŸ¥è¯†ç‚¹æ€»ç»“

| çŸ¥è¯†ç‚¹ | è¯´æ˜ |
|--------|------|
| **äº‹ä»¶ç»§æ‰¿** | ç›‘å¬çˆ¶ç±»äº‹ä»¶çš„ç›‘å¬å™¨ä¹Ÿèƒ½æ¥æ”¶å­ç±»äº‹ä»¶ |
| **åŒæ­¥vså¼‚æ­¥** | é»˜è®¤åŒæ­¥æ‰§è¡Œï¼Œä½¿ç”¨@Asyncå®ç°å¼‚æ­¥ |
| **æ‰§è¡Œé¡ºåº** | é€šè¿‡@Orderæ§åˆ¶å¤šä¸ªç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåº |
| **äº‹åŠ¡ç›‘å¬** | @TransactionalEventListeneråœ¨äº‹åŠ¡ç‰¹å®šé˜¶æ®µè§¦å‘ |
| **æ¡ä»¶ç›‘å¬** | ä½¿ç”¨conditionå±æ€§ç²¾ç¡®æ§åˆ¶è§¦å‘æ¡ä»¶ |
| **å¼‚å¸¸éš”ç¦»** | ç›‘å¬å™¨å¼‚å¸¸ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹å’Œå…¶ä»–ç›‘å¬å™¨ |

### ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ 

- [6. Spring Boot Actuator](6.springboot-actuator.md)ï¼šå­¦ä¹ åº”ç”¨ç›‘æ§ä¸ç®¡ç†
- [7. Spring Boot éƒ¨ç½²](7.springboot-deploy.md)ï¼šå­¦ä¹ åº”ç”¨éƒ¨ç½²æ–¹å¼

> **ğŸ‰ æ­å–œï¼** ä½ å·²ç»æŒæ¡äº†Spring Bootç›‘å¬å™¨çš„æ ¸å¿ƒçŸ¥è¯†ï¼Œå¯ä»¥å¼€å§‹åœ¨é¡¹ç›®ä¸­åº”ç”¨äº†ï¼